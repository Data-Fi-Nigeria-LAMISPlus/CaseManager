<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">

    <property name="autoIncrement" value="true"/>
    <changeSet failOnError="true" id="20230323-0001" author="victor">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="case_manager"/>
            </not>
        </preConditions>
        <sql>
            CREATE TABLE IF NOT EXISTS case_manager (
            id INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
            uuid VARCHAR(255) NOT NULL,
            designation VARCHAR(255),
            first_name VARCHAR(255),
            last_name VARCHAR(255),
            sex VARCHAR(255),
            phone_number VARCHAR(255),
            facility_id INTEGER,
            create_date TIMESTAMP WITHOUT TIME ZONE,
            CONSTRAINT pk_case_manager PRIMARY KEY (id)
            );

            ALTER TABLE case_manager ADD CONSTRAINT uc_case_manager_uuid UNIQUE (uuid);
        </sql>
    </changeSet>
    <changeSet failOnError="true" id="20230323-0003" author="victor">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="case_manager_patients"/>
            </not>
        </preConditions>
        <sql>
            CREATE TABLE case_manager_patients (
            id INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
            full_name VARCHAR(255),
            sex VARCHAR(255),
            current_status VARCHAR(255),
            hospital_no VARCHAR(255),
            age VARCHAR(255),
            facility_id BIGINT,
            biometric_status VARCHAR(255),
            person_uuid VARCHAR(255),
            date_of_birth VARCHAR(255),
            phone_number VARCHAR(255),
            state VARCHAR(255),
            lga VARCHAR(255),
            case_manager_id INTEGER,
            create_date TIMESTAMP WITHOUT TIME ZONE,
            CONSTRAINT pk_case_manager_patients PRIMARY KEY (id)
            );

            ALTER TABLE case_manager_patients ADD CONSTRAINT FK_CASE_MANAGER_PATIENTS_ON_CASE_MANAGER FOREIGN KEY (case_manager_id) REFERENCES case_manager (id);
        </sql>
    </changeSet>
	<changeSet failOnError="true" id="20230606-00001" author="Emeka">
		<preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*)
                FROM pg_attribute
                WHERE attrelid = (SELECT oid FROM pg_class WHERE relname = 'case_manager')
                  AND attname = 'address';
            </sqlCheck>
        </preConditions>
        <sql>
			ALTER TABLE IF EXISTS case_manager ADD COLUMN address character varying;
			ALTER TABLE IF EXISTS case_manager ADD COLUMN created_by character varying;
			ALTER TABLE IF EXISTS case_manager ADD COLUMN modified_by character varying;
			ALTER TABLE IF EXISTS case_manager ADD COLUMN archived INTEGER;
			ALTER TABLE IF EXISTS case_manager ADD COLUMN active BOOLEAN;
			ALTER TABLE IF EXISTS case_manager ADD COLUMN religion character varying;
			ALTER TABLE IF EXISTS case_manager ADD COLUMN date_modified TIMESTAMP WITHOUT TIME ZONE;
        </sql>
    </changeSet>
    <changeSet failOnError="true" id="20230606-00002" author="Emeka">
		<preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*)
                FROM pg_attribute
                WHERE attrelid = (SELECT oid FROM pg_class WHERE relname = 'case_manager_patients')
                  AND attname = 'date_assigned';
            </sqlCheck>
        </preConditions>
        <sql>
			ALTER TABLE IF EXISTS case_manager_patients ADD COLUMN date_assigned TIMESTAMP WITHOUT TIME ZONE;
			ALTER TABLE IF EXISTS case_manager_patients ADD COLUMN date_created TIMESTAMP WITHOUT TIME ZONE;
			ALTER TABLE IF EXISTS case_manager_patients ADD COLUMN date_modified TIMESTAMP WITHOUT TIME ZONE;
			ALTER TABLE IF EXISTS case_manager_patients ADD COLUMN created_by character varying;
			ALTER TABLE IF EXISTS case_manager_patients ADD COLUMN modified_by character varying;
			ALTER TABLE IF EXISTS case_manager_patients ADD COLUMN action character varying;
			ALTER TABLE IF EXISTS case_manager_patients ADD COLUMN uuid character varying;
			ALTER TABLE IF EXISTS case_manager_patients ADD COLUMN date_modified TIMESTAMP WITHOUT TIME ZONE;
        </sql>
    </changeSet>
</databaseChangeLog>